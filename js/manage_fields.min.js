PDbManageFields=function(a){var l={dialogClass:"participants-database-confirm",autoOpen:!1,height:"auto",minHeight:"20"},w={effect:"fadeToggle",duration:100},t="function"!==typeof URLSearchParams?"pdb-manage-fields-tab":((new URLSearchParams(window.location.search)).get("page")+"-tab").replace(/participants-database-/,""),g=a("#confirmation-dialog"),m,h,n,f,E=function(b){b.preventDefault();var c=a(this),d=c.data("thing-name").replace(/^delete_/,""),e=c.closest(".def-line");b=e.find(".title-attribute input").data("title");
var k=c.data("thing");c=e.find("td.group select").val();var x=a("#field_count_"+(c?c:d)),f=x.html();/[0-9]+/.test(f)&&0<f&&"group"===k?(g.html(PDb_L10n.must_remove.replace("{name}",b)),g.dialog(l,{buttons:[{icon:"dashicons dashicons-yes",click:function(){a(this).dialog("close")}}]})):(c=PDb_L10n["delete_confirm_custom_"+e.find(".name-attribute input").val()],g.html(c||PDb_L10n.delete_confirm.replace("{name}",b).replace("{thing}",k)),g.dialog(l,{buttons:[{icon:"dashicons dashicons-yes",click:function(){e.css("opacity",
"0.3");a(this).dialog("close");a.ajax({type:"post",url:ajaxurl,data:{list:[d],action:PDb_L10n.action,task:"delete_"+k,_wpnonce:PDb_L10n._wpnonce,sess:PDb_L10n.sess},beforeSend:function(){},success:function(b){"success"===b.status?(e.slideUp(600,function(){e.remove()}),x.html(f-1),a("#tab_"+d).fadeOut()):e.css("opacity","inherit");b.feedback&&p(b.feedback)}})}},{icon:"dashicons dashicons-no-alt",click:function(){a(this).dialog("close")}}]}));g.dialog("open");return!1},F=function(b){var c=a(this);b=
c.prop("name").replace(/\[(.+)\]/,"[datatype_warning]");var d=a('[name="'+b+'"]').length?a('[name="'+b+'"]'):a("<input>",{name:b,type:"hidden",value:"pending"}).insertAfter(c),e=a("#confirmation-dialog");e.html(PDb_L10n.datatype_confirm);e.dialog(l,{buttons:[{text:PDb_L10n.datatype_confirm_button,class:"confirm-button dashicons-before dashicons-yes",click:function(){d.val("accepted");e.dialog("close");y(c)}},{text:PDb_L10n.datatype_cancel_button,class:"cancel-button dashicons-before dashicons-no",
click:function(){d.val("rejected");c.val(c.data("initState"));e.dialog("close")}}]});e.dialog("open");return!1},y=function(b){b=b.length?b:a(b.target);var c=b.closest(".def-fieldset");c.css({opacity:.3});a.ajax({type:"post",url:ajaxurl,data:{field:c.find('[name$="[name]"]').val(),type:b.val(),action:PDb_L10n.action,task:"update_editor",_wpnonce:PDb_L10n._wpnonce,sess:PDb_L10n.sess},beforeSend:function(){},success:function(b){"success"===b.status&&c.replaceWith(a(b.body));c.css({opacity:1});q()}})},
G=function(){var b=a(this),c=b.closest("tr");"captcha"===b.val()&&(c.find("td.validation select").val("captcha"),c.find("td.readonly input[type=checkbox], td.signup input[type=checkbox]").prop("checked",!0),c.find("td.sortable input[type=checkbox], td.CSV input[type=checkbox], td.persistent input[type=checkbox]").prop("checked",!1))},H=function(){var b=a(this);b.is("[type=checkbox]")?b.data("initState",b.is(":checked")):b.data("initState",b.val())},u=function(){var b=a(this),c=b.data("initState");
if(b.closest(".manage-field-groups").length)var d=a("#status_"+b.closest(".def-fieldset").data("id"));else d=b.closest(".def-fieldset").attr("id").match(/(\d+)/),d=a("#status_"+d[1]);(b.is("[type=checkbox]")?b.is(":checked"):b.val())!==c?(d.attr("value","changed"),z(1)):z(-1)},z=function(b){var c=a("body"),d=c.data("unsavedChanges")||0;1===b?d++:-1===b&&d--;c.data("unsavedChanges",d);0>=d?q():window.onbeforeunload=I},q=function(){window.onbeforeunload=null},A=function(a,c){c.children().each(function(){jQuery(this).width(jQuery(this).width())});
return c},J=function(){a(this).closest(".add-field-inputs, .add-group-inputs").find("[type=submit]").removeClass("disabled").addClass("enabled").prop("disabled",!1)},B=function(b){var c=0,d="";b.find(".def-line").each(function(){var b=a(this),k=c+1E3*b.data("groupid");""!==d&&(d+="&");d=d+b.data("numid")+"="+k;c++});return d},v=function(){var a={};window.location.href.replace(/[?&]+([^=&]+)=([^&]*)/gi,function(b,d,e){a[d]=e});return a},K=function(b){a(this).attr("autocomplete","off");if(13===b.keyCode)return!1},
L=function(){return 1===a.versioncompare("1.9",a.ui.version)?{fx:{opacity:"show",duration:"fast"},cookie:{expires:1}}:{hide:w,show:w,active:Cookies.get(t),activate:function(a,c){Cookies.set(t,c.newTab.index(),{expires:365,path:""})}}},I=function(a){a=a||window.event;var b=PDb_L10n.unsaved_changes;a&&(a.returnValue=b);return b},M=function(){C(a(this),"open")},N=function(){C(a(this),"close")},C=function(b,c){switch(c){case "close":b.closest(".def-fieldset").removeClass("editor-open").addClass("editor-closed");
break;case "open":b.closest(".def-fieldset").removeClass("editor-closed").addClass("editor-open")}a.post(ajaxurl,{action:PDb_L10n.action,task:"open_close_editor",id:b.closest(".field-header").find("[data-id]").data("id"),state:c,_wpnonce:PDb_L10n._wpnonce,sess:PDb_L10n.sess})},O=function(b,c){switch(c){case "close":b.find(".def-fieldset").removeClass("editor-open").addClass("editor-closed");break;case "open":b.find(".def-fieldset").removeClass("editor-closed").addClass("editor-open")}var d=[];b.find("[name*=selectable]").each(function(){d.push(a(this).data("id"))});
a.post(ajaxurl,{action:PDb_L10n.action,task:"open_close_all",list:d,state:c,_wpnonce:PDb_L10n._wpnonce,sess:PDb_L10n.sess})},D=function(){var b=a(this).closest(".attribute-control").next(".validation_message-attribute");switch(a(this).val()){case "no":b.hide();break;default:b.show()}},P=function(b){var c=!1;b.find("[name*=selectable][type=checkbox]").each(function(){a(this).prop("checked")&&(c=!0)});return c},T=function(){m=a(this).closest(".general_fields_control_header");var b=m.next("form");h=
m.find("select.with-selected-action-select").val();a("input[name=with_selected]").val(h);a("select.with-selected-action-select").val(h);n=a(PDb_L10n.loading_indicator).clone();f=Q(b);if(f.length)switch(m.find("button.apply-with-selected").after(n),h){case "delete":R(f,a(this).closest(".manage-fields-wrap").attr("id"));break;case "group":S(f,a(this).prev("select.with-selected-group-select").val());b.find(".manage-fields-update").trigger("click");break;case "add_csv":r("csv",!0);break;case "remove_csv":r("csv",
!1);break;case "add_signup":r("signup",!0);break;case "remove_signup":r("signup",!1)}return!1},r=function(b,c){p(!1);a.each(f,function(d,e){a("#row_"+e+"_"+b+"-"+PDb_L10n.instance_index).prop("checked",c)});a.post(ajaxurl,{action:PDb_L10n.action,task:"update_param",param:b,setting:c,selection:h,_wpnonce:PDb_L10n._wpnonce,sess:PDb_L10n.sess,list:f},function(a){n.remove();a.feedback&&p(a.feedback)},"json")},S=function(b,c){a.each(b,function(b,e){a("#row_"+e+"_group-"+PDb_L10n.instance_index).val(c).trigger("change")})},
Q=function(b){var c=[];b.find("[name*=selectable]:checked").each(function(){c.push(a(this).data("id"))});return c},R=function(b,c){var d=1<b.length?PDb_L10n.delete_confirm_fields:PDb_L10n.delete_confirm_field,e=[];a.each(b,function(b,c){c=a("#db_row_"+c);b=c.find(".name-attribute input").val();c=c.find(".title-attribute input").data("title");e.push(PDb_L10n["delete_confirm_custom_"+b]||c)});g.html(d+"<ul><li>"+e.join("</li><li>")+"</li></ul>");g.dialog(l,{buttons:[{icon:"dashicons dashicons-yes",
click:function(){a.each(b,function(b,c){a("#db_row_"+c).css("opacity","0.3")});a(this).dialog("close");a.ajax({type:"post",url:ajaxurl,data:{list:b,action:PDb_L10n.action,task:"delete_field",_wpnonce:PDb_L10n._wpnonce},success:function(d){a.each(b,function(b,c){a("#db_row_"+c).slideUp(600,function(){a(this).remove()})});var e=a("#field_count_"+c);e.html(parseInt(e.html())-b.length);a(".with-selected-control").slideUp(300);p(d.feedback)}})}},{icon:"dashicons dashicons-no-alt",click:function(){a(this).dialog("close");
n.remove()}}]});g.dialog("open")},p=function(b){a("[id^=pdb-manage_fields_]").slideUp(600,function(){a(this).remove()});b&&a("#fields-tabs .ui-tabs-nav").after(b)},U={helper:A,handle:".dragger",update:function(b,c){a.post(ajaxurl,{action:PDb_L10n.action,task:"reorder_fields",_wpnonce:PDb_L10n._wpnonce,list:B(a(this))})}},V={helper:A,handle:".dragger",update:function(b,c){a.post(ajaxurl,{action:PDb_L10n.action,task:"reorder_groups",_wpnonce:PDb_L10n._wpnonce,list:B(a(this))})}};return{init:function(){var b=
a("#fields-tabs");q();b.tabs(L());b.find(".manage-fields input[type=text], .manage-fields textarea, .manage-fields select, .manage-fields input[type=checkbox]").each(H);b.find(".attribute-control input, .attribute-control textarea").on("input",u);b.find(".attribute-control select, .attribute-control input[type=checkbox]").on("change",u);b.find(".def-fieldset.heading-form-element").on("pdb-tinymce-change",".mce-container",u);b.on("keypress","form",K);b.on("change",".form-element-select.column-empty",
y);b.on("change.confirm",".form-element-select.column-has-values",F);a(".manage-fields-wrap").on("change",".manage-fields tbody .form_element-attribute select",G);b.find(".manage-fields a.delete").click(E);b.find("input.add_field").on("input",J);a(".manage-field-groups").sortable(V);a('section[id$="_fields"]').sortable(U);a(".manage-fields-update, .manage-groups-update").on("click",q);a(".manage-fields").on("click",".def-fieldset .editor-opener.field-open-icon",M);a(".manage-fields").on("click",".def-fieldset .editor-opener.field-close-icon",
N);a(".def-fieldset").on("change",".validation-attribute select",D).find(".validation-attribute select").each(D);a(".button-showhide").slideUp();a("button.showhide").on("click.show",function(){a(".button-showhide").not("#"+a(this).attr("for")).slideUp();a("#"+a(this).attr("for")).slideToggle("slow")});a("button[name=add-field-cancel]").click(function(b){b.preventDefault();a(this).closest(".button-showhide").slideUp();a(this).closest(".button-showhide").find("[type=submit]").removeClass("enabled").addClass("disabled").prop("disabled",
!0)});a(".with-selected-control").slideUp(300);a("[name*=selectable][type=checkbox]").change(function(){var b=a(this).closest("form").prev(".general_fields_control_header").find(".with-selected-control");P(a(this).closest("form"))?b.slideDown(300):b.slideUp(300)});a(".with-selected-group-select").hide();a(".with-selected-action-select").change(function(){a(this).next(".with-selected-group-select").hide(300);"group"===a(this).val()&&a(this).next(".with-selected-group-select").show(300);a(".apply-with-selected").prop("disabled",
""===a(this).val())}).trigger("change");a(".general_fields_control_header .check-all input[type=checkbox]").click(function(){a(this).closest(".general_fields_control_header").next("form").find("[name*=selectable]").prop("checked",a(this).prop("checked")).trigger("change")});a(".general_fields_control_header .openclose-all").click(function(){var b=a(this).find(".dashicons"),d="close";b.hasClass("field-open-icon")&&(d="open");O(a(this).closest(".manage-fields-wrap"),d);b.toggleClass("field-close-icon field-open-icon")});
a(".apply-with-selected").click(T);a("#fields-tabs").on("click",".notice-dismiss",function(){a(this).closest("div.notice").remove()});a("textarea.option-list").on("input",function(){this.validity.valueMissing||this.setCustomValidity("")}).on("invalid",function(){this.setCustomValidity(a(this).data("message"));a(this).closest(".editor-closed").find(".field-open-icon").trigger("click")});v().newfield&&a("button.showhide.add-field").each(function(){var b=a(this);if(b.closest(".manage-fields-wrap").is(":visible")){var d=
a("#"+b.attr("for"));d.find("[name=title]").val(decodeURIComponent(v().newfield.replace(/\+/g,"%20")));d.find("[name=form_element] option[value="+v().formelement+"]").attr("selected","selected");b.trigger("click.show");d.find("[type=submit]").removeClass("disabled").addClass("enabled").prop("disabled",!1)}})},lastTab:t}}(jQuery);jQuery(function(){PDbManageFields.init()});